---
import Layout from "../../layouts/Layout.astro";
import HeroSmall from "../../components/shared/PageComponents/HeroSmall/HeroSmall.astro";
import ArticleHeader from "../../components/post/ArticleHeader/ArticleHeader.astro";
import ArticleBody from "../../components/post/ArticleBody/ArticleBody.astro";
import ArticleGallery from "../../components/post/ArticleGallery/ArticleGallery.astro";
import ArticleNav from "../../components/post/ArticleNav/ArticleNav.astro";

import {
  Page_Seo_Query,
  Default_Page_Hero_Query,
} from "../../data/page/queries";

export async function getStaticPaths() {
  const response = await fetch(`${import.meta.env.WPGRAPHQL_URL}`, {
    method: "POST",
    headers: {
      "content-type": "application/json",
    },
    body: JSON.stringify({
      query: `
        query postsQuery {
            posts(first: 999999) {
                nodes {
                    uri
                    slug
                    title
                }   
            }
        }
        `,
    }),
  });

  const { data } = await response.json();
  return data.posts.nodes.map((post: any, index: any) => {
    return {
      params: { slug: `${post.slug}` },
      props: {
        next: index === 0 ? null : data.posts.nodes[index - 1],
        prev:
          index === data.posts.nodes.length - 1
            ? null
            : data.posts.nodes[index + 1],
      },
    };
  });
}

const response = await fetch(`${import.meta.env.WPGRAPHQL_URL}`, {
  method: "POST",
  headers: {
    "content-type": "application/json",
  },
  body: JSON.stringify({
    query: `
    query postQuery($id: ID!) {
      post(idType: SLUG, id: $id) {
        ${Page_Seo_Query}
        title
        date
        postFields {
          excerpt
          article
          featuredImage  {
            node {
              sourceUrl
              altText
              mediaDetails {
                width
                height
              }
            }
          }

          galleryRequired
          gallery {
            nodes {
              sourceUrl
              altText
              mediaDetails {
                width
                height
              }
            }
          }
        }
      }

      ${Default_Page_Hero_Query}

    }
    `,
    variables: {
      id: Astro.params["slug"],
    },
  }),
});

const {
  data: {
    siteWideSettings,
    post,
    post: { seoMetaTags },
  },
} = await response.json();
---

<Layout
  metaImg={seoMetaTags.seoMetaInformation.metaImage.sourceUrl}
  metaTitle={seoMetaTags.seoMetaInformation.metaTitle}
  metaDescription={seoMetaTags.seoMetaInformation.metaDescription}
>
  <HeroSmall data={siteWideSettings.defaultHeroHeaders.heroSmallComponent} />
  <ArticleHeader
    title={post.title}
    featuredImage={post.postFields.featuredImage}
  />
  <ArticleBody article={post.postFields.article} />
  {
    post.postFields.galleryRequired && (
      <ArticleGallery gallery={post.postFields.gallery} />
    )
  }
  <ArticleNav data={Astro.props} />
</Layout>
