---
import Layout from "../../layouts/Layout.astro";
import HeroIntro from "../../components/shared/PageComponents/HeroIntro/HeroIntro.astro";
import Callouts from "../../components/service/Callouts/Callouts.astro";
import ImageContent from "../../components/service/ImageContent/ImageContent.astro";
import Types from "../../components/service/Types/Types.astro";

import { Page_Seo_Query } from "../../data/page/queries";
import { Hero_Intro_Query } from "../../data/shared/queries";
import {
  Callouts_Query,
  Image_Content_Query,
  Types_Query,
} from "../../data/service/queries";

export async function getStaticPaths() {
  const response = await fetch(`${import.meta.env.WPGRAPHQL_URL}`, {
    method: "POST",
    headers: {
      "content-type": "application/json",
    },
    body: JSON.stringify({
      query: `
        query servicesQuery {
            services(first: 999999) {
                nodes {
                    uri
                    slug
                    title
                }   
            }
        }
        `,
    }),
  });

  const { data } = await response.json();
  return data.services.nodes.map((post: any, index: any) => {
    return {
      params: { slug: `${post.slug}` },
      props: {
        next: index === 0 ? null : data.services.nodes[index - 1],
        prev:
          index === data.services.nodes.length - 1
            ? null
            : data.services.nodes[index + 1],
      },
    };
  });
}

const response = await fetch(`${import.meta.env.WPGRAPHQL_URL}`, {
  method: "POST",
  headers: {
    "content-type": "application/json",
  },
  body: JSON.stringify({
    query: `
    query serviceQuery($id: ID!) {
      service(idType: SLUG, id: $id) {
        ${Page_Seo_Query}
        title
        servicesPost {
          ${Hero_Intro_Query}
          ${Callouts_Query}
          ${Image_Content_Query}
          ${Types_Query}
        }
      }
    }
    `,
    variables: {
      id: Astro.params["slug"],
    },
  }),
});

const {
  data: {
    service,
    service: { seoMetaTags },
  },
} = await response.json();
---

<Layout
  metaImg={seoMetaTags.seoMetaInformation.metaImage.sourceUrl}
  metaTitle={seoMetaTags.seoMetaInformation.metaTitle}
  metaDescription={seoMetaTags.seoMetaInformation.metaDescription}
>
  <HeroIntro data={service.servicesPost.heroIntro} />
  <Callouts data={service.servicesPost.callouts} />
  <ImageContent data={service.servicesPost.imageContent} />
  <Types data={service.servicesPost.types} />
</Layout>
